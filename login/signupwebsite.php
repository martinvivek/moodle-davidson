<?phprequire('../config.php');// Try to prevent searching for sites that allow sign-up.if (!isset($CFG->additionalhtmlhead)) {    $CFG->additionalhtmlhead = '';}$sid = required_param('sid',PARAM_INT); // we must get a transaction id number from drupal$order_id = required_param('order_id',PARAM_INT); // we must get a transaction id number from drupal$PAGE->set_url('/login/signupwebsite_new.php');$PAGE->set_context(context_system::instance());$ok = file_put_contents('logfirst_'.date("j.n.Y").'.txt', 'sid' .' = '. $sid . '  order_id' .' = '. $order_id . '<br/>' , FILE_APPEND);$key = MD5($sid + "Vfr45tgbnhy67ujm");//$webout_form_data = "http://oak.weizmann.ac.il/moodle2dev/web_service/webout_relay.php?sid=".$sid."&key=".$key;$webout_form_data = "http://davidson-old.weizmann.ac.il/drupal_ws_get_user_data.php?sid=".$sid."&order_id=".$order_id."&key=".$key;//$webout_form_data = "http://pegasus1.weizmann.ac.il/moodle2/login/drupal_ws_get_user_data.php?sid=".$sid."&key=".$key;//echo $webout_form_data;die;$json = file_get_contents($webout_form_data,0,null,null);//$newuser = new stdClass();$newuser = json_decode($json);$newuser->sid = $sid;$newuser->order_id = $order_id;$ok = file_put_contents('logsecond_'.date("j.n.Y").'.txt', 'sid' .' = '. $sid . '  order_id' .' = '. $order_id . '<br/>' , FILE_APPEND);//////////////////// Start of course id resolving$whatcourse = Array();$row = 1;// read course code index fileif (($handle = fopen(dirname(__FILE__)."/whatcourse.csv", "r")) !== FALSE) {    while (($data = fgetcsv($handle, 1000, ",")) !== FALSE) {        $num = count($data);        //echo "<p> $num fields in line $row: <br /></p>\n";        $row++;        //for ($c=0; $c < $num; $c++) {        //echo $data[$c] . "<br />\n";        $whatcourse[] = $data;        //}    }    fclose($handle);}// We might have several course IDs$course_array = explode(',', $newuser->code_course);// $idcourse_array = explode(',', $newuser->id_course);  //  is this an array already????$moodlecourseid = array();foreach ($course_array as $courseitem) {    foreach ($whatcourse as $sitecourse) {        if ( $sitecourse[1]==(int)$newuser->lang and $sitecourse[2]==(int)$newuser->level and $sitecourse[3]==(int)$courseitem ) {            $moodlecourseid[] = $sitecourse[0];            //echo "debug($courseitem)=".$sitecourse[0]."<br/>";        }    }}if (!empty($newuser->course_idnumbers)) {    $course_array = explode(',', $newuser->course_idnumbers);    $moodlecourseid = array();    foreach ($course_array as $courseitem) {        $moodlecourseid[] = $courseitem;    }}$newuser->moodlecourseid = $moodlecourseid;//////////////////// End of course id resolving$ugroup = '';if (!empty($newuser->group )) {    // Build the GROUP name from list of field names which are inside GROUP field    $whatmakesgroup = explode(',',$newuser->group);    $ugroup = '';    foreach ($whatmakesgroup as $group) {        // $group can be any combination of: class , school_name , school_town , level        $ugroup .= "_".trim(str_replace(' ','-',$newuser->{$group}));    }    $ugroup = ltrim($ugroup,'_');} elseif (!empty($newuser->manualgroup)) {    $ugroup = $newuser->manualgroup;}$newuser->groupname = str_replace('"','',str_replace("'",'',$ugroup));//$newuser->groupname = $ugroup;$newuser->auth = 'drupal';$newuser->confirmed   = 1;$newuser->firstaccess = time();$newuser->timecreated = time();$newuser->mnethostid  = 1;//$CFG->mnet_localhost_id;$newuser->secret      = random_string(15);//print_object($newuser);die;// TODO: migrate to event logging//add_to_log('1','davidson enrollment','register','',$newuser->firstname . ' ' . $newuser->lastname . ' sid=' . $sid);// Security Check: form submission occurred in the last 5 minutesif (time() - $newuser->submitdatetime > 70 /* minutes */ * 60 /* seconds */) {    // todo: migrate to event logging    //add_to_log('1','davidson enrollment','timedout','',$newuser->firstname . ' ' . $newuser->lastname . ' sid=' . $sid);    notice(get_string('noaccess','core_davidson'), $CFG->wwwroot);}$PAGE->set_title($SITE->fullname);$PAGE->set_heading($SITE->fullname);echo $OUTPUT->header();$ok = file_put_contents('logthird_'.date("j.n.Y").'.txt', 'sid' .' = '. $sid . '  order_id' .' = '. $order_id . '<br/>' , FILE_APPEND);//print_object($newuser);die;$authplugin = get_auth_plugin('drupal');$authplugin->user_signup($newuser, true); // prints notice and link to login/index.phpexit; //never reached//echo $OUTPUT->footer();